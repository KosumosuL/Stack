"use strict";var eType,_fs=require("fs"),_path=require("path"),MODULES_NATIVE={base:"system",ext:"service",other:"card",android:"android",hapIO:"hap.io"},REG_MODULE_NAME="['\"]@(("+MODULES_NATIVE.base+"|"+MODULES_NATIVE.ext+"|"+MODULES_NATIVE.other+"|"+MODULES_NATIVE.hapIO+"|"+MODULES_NATIVE.android+")(.[0-9a-zA-Z]+)?)",REG_BASE_MODULE_NAME=/^['\"]@system['\"]?$/,REG_EXT_MODULE_NAME=/^['\"]@service['\"]?$/,REG_OTHER_MODULE_NAME=/^['\"]@card['\"]?$/,REG_ANDROID_MODULE_NAME=/^['\"]@android['\"]?$/,REG_HAP_MODULE_NAME=/^['\"]@hap['\"]?$/;function frameworkInit(){global.framework={featureMap:[{apiLevel:1e3,features:[MODULES_NATIVE.base+".battery",MODULES_NATIVE.base+".barcode",MODULES_NATIVE.base+".brightness",MODULES_NATIVE.base+".bluetooth",MODULES_NATIVE.base+".calendar",MODULES_NATIVE.base+".clipboard",MODULES_NATIVE.base+".device",MODULES_NATIVE.base+".fetch",MODULES_NATIVE.base+".file",MODULES_NATIVE.base+".geolocation",MODULES_NATIVE.base+".media",MODULES_NATIVE.base+".network",MODULES_NATIVE.base+".notification",MODULES_NATIVE.base+".prompt",MODULES_NATIVE.base+".sensor",MODULES_NATIVE.base+".share",MODULES_NATIVE.base+".storage",MODULES_NATIVE.base+".vibrator",MODULES_NATIVE.base+".webview",MODULES_NATIVE.base+".app",MODULES_NATIVE.base+".router",MODULES_NATIVE.base+".request",MODULES_NATIVE.base+".file",MODULES_NATIVE.base+".audio",MODULES_NATIVE.base+".image",MODULES_NATIVE.base+".record",MODULES_NATIVE.base+".shortcut",MODULES_NATIVE.base+".volume",MODULES_NATIVE.base+".package",MODULES_NATIVE.base+".cipher",MODULES_NATIVE.ext+".pay",MODULES_NATIVE.ext+".push",MODULES_NATIVE.ext+".share",MODULES_NATIVE.ext+".wxpay",MODULES_NATIVE.ext+".alipay",MODULES_NATIVE.ext+".stats",MODULES_NATIVE.ext+".account"]},{apiLevel:1010,features:[MODULES_NATIVE.base+".contact",MODULES_NATIVE.base+".wifi",MODULES_NATIVE.base+".sms"]},{apiLevel:1020,features:[MODULES_NATIVE.base+".websocketfactory",MODULES_NATIVE.other+".message"]},{apiLevel:1030,features:[MODULES_NATIVE.base+".ai",MODULES_NATIVE.ext+".wxaccount",MODULES_NATIVE.ext+".wbaccount",MODULES_NATIVE.ext+".qqaccount"]},{apiLevel:1035,features:[MODULES_NATIVE.base+".alarm",MODULES_NATIVE.android+".settings"]},{apiLevel:1037,features:[MODULES_NATIVE.base+".mediaquery"]},{apiLevel:1045,features:[MODULES_NATIVE.ext+".health"]},{apiLevel:1046,features:[MODULES_NATIVE.base+".tts"]},{apiLevel:1050,features:[MODULES_NATIVE.hapIO+".MessageChannel",MODULES_NATIVE.ext+".exchange"]}],reservedFeatureExclude:[MODULES_NATIVE.base+".app",MODULES_NATIVE.base+".router"],decalredFeatureList:[MODULES_NATIVE.base+".webview"],reservedFeatures:[],project:{featureList:[],minPlatformVersion:1e3,module:{usedBaseAll:!1,usedExtAll:!1,usedOtherAll:!1,usedAndroidAll:!1}}};for(var e=global.framework.featureMap.length,a=0;a<e;a++)global.framework.reservedFeatures=global.framework.reservedFeatures.concat(global.framework.featureMap[a].features)}function updateSourceScript(e){var n=[],a=new RegExp(REG_MODULE_NAME,"g"),E=new RegExp(REG_MODULE_NAME);return(e.match(a)||[]).forEach(function(e){if(REG_BASE_MODULE_NAME.test(e))n.push({reason:"WARNING: You have introduced the system module. Ensure that the permission statement is complete."}),global.framework.project.module.usedBaseAll=!0;else if(REG_EXT_MODULE_NAME.test(e))n.push({reason:"WARNING: You have introduced the service module. Ensure that the permission statement is complete."}),global.framework.project.module.usedExtAll=!0;else if(REG_OTHER_MODULE_NAME.test(e))global.framework.project.module.usedOtherAll=!0,n.push({reason:"WARNING: You have introduced the card module. Ensure that the permission statement is complete."});else if(REG_ANDROID_MODULE_NAME.test(e))global.framework.project.module.usedAndroidAll=!0,n.push({reason:"WARNING: You have introduced the android module. Ensure that the permission statement is complete."});else if(REG_HAP_MODULE_NAME.test(e))global.framework.project.module.usedAndroidAll=!0,n.push({reason:"WARNING: You have introduced the hap module. Ensure that the permission statement is complete."});else{var a=(e.match(E)||[])[1];if(-1===global.framework.project.featureList.indexOf(a)){for(var r=global.framework.featureMap.length,t=!0,s=0;s<r;s++){if(-1!==global.framework.featureMap[s].features.indexOf(a)){var o=global.framework.featureMap[s].apiLevel;global.framework.project.featureList.push(a),o>global.framework.project.minPlatformVersion&&(global.framework.project.minPlatformVersion=o),t=!1;break}}t&&n.push({reason:"WARNING: You have introduced an unidentified native module: "+a})}}}),{fileCont:e,logFeatureList:n}}function updateManifest(e,a){var r="true"===process.env.uglifyjs,t=null;try{t=JSON.parse(e)}catch(e){return console.error("ERROR: An error occurred when parsing the manifest.json file: "+e.message+"\n @ "+a+"\n"),void(eType.type="ERROR")}if(t){r||(t.debugable=!0),t.features=t.features||[];var s=[].concat(global.framework.project.featureList),o=[],n=[],E=[];if(t.features.forEach(function(e){var a=s.indexOf(e.name);-1!==a?(s.splice(a,1),n.push(e.name)):-1===global.framework.decalredFeatureList.indexOf(e.name)&&o.push(e.name)}),0<o.length)for(var i=0;i<o.length;i++)-1!==n.indexOf(o[i])&&(E.push(o[i]),o.splice(i,1),i--);0<E.length&&(console.warn("WARNING: The manifest.json file contains a repeatedly declared interface: "+E.join(", ")+"\n @ "+a+"\n"),eType.type="WARN",eType.warnCount++),0<o.length&&0<o.length&&(console.warn("WARNING: The manifest.json file has declared but has not used the interface:  "+o.join(", ")+"\n @ "+a+"\n"),eType.type="WARN",eType.warnCount++);var l=[];if(s.forEach(function(e){-1!==global.framework.reservedFeatures.indexOf(e)&&-1===global.framework.reservedFeatureExclude.indexOf(e)&&l.push(e)}),0<s.length){var u=l.map(function(e){return{name:e}});t.features=t.features.concat(u),0<l.length&&(console.warn("WARNING: The manifest.json file has not declared the interface: "+l.join(", ")+"\n @ "+a+"\n"),eType.type="WARN",eType.warnCount++)}return(t.minPlatformVersion||1e3)<global.framework.project.minPlatformVersion&&(console.warn("WARNING: You have introduced the "+global.framework.project.minPlatformVersion+" interface, which is inconsistent with `minPlatformVersion` that is declared in Manifest.json.\n @ "+a+"\n"),eType.type="WARN",eType.warnCount++),e=JSON.stringify(t,null,2)}}function updateProjectManifest(e){eType={type:null,warnCount:0};try{var a=_fs.readFileSync(e,"utf8"),r=_path.join(e,"..","..","build","manifest.json");_fs.writeFileSync(r,updateManifest(a,e),"utf8")}catch(e){throw console.error("ERROR: An error occurred when reading ["+r+"]: "+e.message),eType.type="ERROR",e}return eType}Object.defineProperty(exports,"__esModule",{value:!0}),frameworkInit(),exports.updateSourceScript=updateSourceScript,exports.updateProjectManifest=updateProjectManifest;