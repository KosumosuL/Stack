"use strict";var _fs=require("fs"),_path=require("path"),_shared=require("./shared"),_ability=require("./ability"),nodePath=process.env.nodePath||"node",spawnSync=require("child_process").spawnSync;function FaZipPlugin(r){this.options=r}function printResult(){var r=0,n=0;if(0<mWarningCount){for(var t=mStats.compilation.warnings,i=t.length,e=0;e<i;e++){var o=t[e].message.replace("(Emitted value instead of an instance of Error) ","");o=o.replace(/Module Warning[^\n]+\n/,""),/^NOTE:/.test(o)?n++:(r++,/^WARNING:/.test(o)||(o="WARNING: "+o+"\n")),console.error(o)}i<mWarningCount&&(r=r+mWarningCount-i)}if(0<mErrorCount)for(var a=mStats.compilation.errors,s=a.length,c=0;c<s;c++)console.error(a[c].message.replace(/Module Error[^\n]+\n/,"").replace("(Emitted value instead of an instance of Error) ",""));if(0<mErrorCount+r+n){var l,u={};l=0<mErrorCount?(u.ERROR=mErrorCount,"FAIL "):"SUCCESS ",0<r&&(u.WARN=r),0<n&&(u.NOTE=n),console.error("COMPILE RESULT:"+l+JSON.stringify(u))}else console.error("COMPILE RESULT:SUCCESS ")}function checkManifestFile(r){var n=_shared.updateProjectManifest(r);n&&("ERROR"===n.type?mErrorCount++:"WARN"===n.type&&(mWarningCount+=n.warnCount))}function checkAbilityXml(r){var n=_ability.abilityCopyAndCheck(r);n&&("ERROR"===n.type?mErrorCount++:"WARN"===n.type&&(mWarningCount+=n.warnCount))}function signRpk(r,n,t,i){if(_fs.existsSync(r.src)){var e={name:r.name,src:r.src,output:r.output},o=spawnSync(nodePath,[_path.join(__dirname,"build-sign-file.js"),JSON.stringify(e),t,i]).stderr;o&&0<o.length&&(console.error(o.toString()),mErrorCount++)}}var mStats,mErrorCount=0,mWarningCount=0;FaZipPlugin.prototype.apply=function(r){var o=this.options;r.plugin("done",function(r){(mStats=r).compilation.errors&&(mErrorCount=r.compilation.errors.length),mStats.compilation.warnings&&(mWarningCount=r.compilation.warnings.length);var n=_path.join(o.src,".."),t="debug";o.sign&&(t="release");var i=_path.join(n,"sign",t,"private.pem"),e=_path.join(n,"sign",t,"certificate.pem");_fs.existsSync(i)||(console.error("ERROR: The private key file is missing. Packaging failed: "+i),mErrorCount++),_fs.existsSync(e)||(console.error("ERROR: The certificate file is missing. Packaging failed: "+e),mErrorCount++),0<mErrorCount?printResult():(checkManifestFile(_path.join(n,"src","manifest.json")),0<mErrorCount||(checkAbilityXml(_path.join(n,"src","ability.xml")),0<mErrorCount||(signRpk(o,n,i,e),printResult())))})},module.exports=FaZipPlugin;