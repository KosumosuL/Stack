"use strict";var loaderUtils=require("loader-utils"),path=require("path"),fs=require("fs"),parser=require("./parser"),utils=require("./utils"),validator=require("./template/validator"),packageJsonPath=path.resolve(__dirname,"../package.json"),defaultLoaders={none:"",component:path.resolve(__dirname,"loader.js"),fragment:path.resolve(__dirname,"fa-fragment-loader.js"),template:path.resolve(__dirname,"fa-template-loader.js"),style:path.resolve(__dirname,"fa-style-loader.js"),script:path.resolve(__dirname,"fa-script-loader.js"),json:path.resolve(__dirname,"fa-json-loader.js"),babel:utils.loadBabelModule("babel-loader"),access:path.resolve(__dirname,"fa-access-loader.js")};function makeLoaderString(e,r){r=r||{};var a=void 0;return"component"===e?(a=[{name:defaultLoaders.component,query:{type:"component"}}],utils.stringifyLoaders(a)):"template"===e?(a=[{name:defaultLoaders.json},{name:defaultLoaders.template}],r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"templates"}}),utils.stringifyLoaders(a)):"style"===e?(a=[{name:defaultLoaders.json},{name:defaultLoaders.style,query:{index:0,type:"styles",resourcePath:r.resourcePath}}],r.lang&&a.push({name:utils.loadBabelModule(r.lang+"-loader")}),r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"styles",resourcePath:r.resourcePath}}),utils.stringifyLoaders(a)):"script"===e?(a=[{name:defaultLoaders.script},{name:defaultLoaders.access},{name:defaultLoaders.babel,query:{presets:[utils.loadBabelModule("@babel/preset-env")],plugins:[utils.loadBabelModule("@babel/plugin-transform-modules-commonjs"),path.resolve(__dirname,"jsx-loader.js")],comments:"false"}}],r.source||a.push({name:defaultLoaders.fragment,query:{index:0,type:"scripts"}}),utils.stringifyLoaders(a)):void 0}function loader(e,r,a){var t=(loaderUtils.parseQuery(e.query),loaderUtils.parseQuery(e.resourceQuery)),s=t.entry,o=e.resourcePath,n=path.relative(".",o),l=s?n:t.name||utils.getNameByPath(o);validator.default.isReservedTag(l)&&utils.logWarn(e,[{reason:"ERROR: The file name must not contain reserved character:"+l}]),utils.print({query:e.loaderQuery,resourceQuery:e.resourceQuery,resourcePath:e.resourcePath,name:l});var i="",p=parser.parseFragment(r),u=[];if(p.import.length)for(var d=0;d<p.import.length;d++){var m=p.import[d];if(!m.src)return utils.logWarn(e,[{reason:"ERROR: To import components, you need to set attribute `src`."}]),"";m.name||(m.name=utils.getNameByPath(m.src)),m.name=m.name.toLowerCase(),validator.default.isReservedTag(m.name)&&utils.logWarn(e,[{reason:"ERROR: Attribute `name` of the imported component must not use the reserved character: "+m.name}]),u.push(m.name);var c=m.src,f=path.join(path.dirname(o),c);if(!fs.existsSync(f)||fs.statSync(f).isDirectory())if(fs.existsSync(f+".ux"))c+=".ux";else if(fs.existsSync(f+".mix"))c+=".mix";else{if(!fs.statSync(f).isDirectory)return utils.logWarn(e,[{reason:"ERROR: Import file does not exist, filepath : "+f}]),"";for(var h=fs.readdirSync(f),y="",g=[],v=[],$=0;$<h.length;$++)if((y=h[$]).match(/\.ux/)&&g.push(y),"index.ux"===y.toLowerCase()){v.push(y);break}if(v.length)c=path.join(f,v[0]);else{if(1!==g.length)return utils.logWarn(e,[{reason:"ERROR: Please specify the import file, src : "+c}]),"";utils.logWarn(e,[{reason:"NOTE: Import file is by default: "+path.join(c,g[0])}]),c=path.join(f,g[0])}}i+=utils.makeRequireString(e,makeLoaderString("component",{source:m.src}),c+"?name="+m.name)}if(p.depends.length){var _={};try{for(var x,R=p.depends[Symbol.iterator](),L=(R.next(),!0),S=p.depends[Symbol.iterator]();!(L=(x=S.next()).done);L=!0){var b=".ux",q=x.value,j=path.resolve(path.dirname(o),q+b);fs.existsSync(j)||(b=".mix",j=path.resolve(path.dirname(o),q+b)),_[q]=j,u.indexOf(q)<0&&fs.existsSync(j)&&(i+=utils.makeRequireString(e,makeLoaderString("none"),"./"+q+b))}}catch(r){throw utils.print(r),r}finally{!L&&R.return&&R.return()}}if(!p.template.length)return utils.logWarn(e,[{reason:"ERROR: The template fragment is required."}]),"";var k=p.template[0],P=o;if(k.src&&(P=k.src),i+="var $app_template$ = "+utils.makeRequireString(e,makeLoaderString("template",{source:k.src}),P),p.style.length){var O=p.style[0],E=o;O.src&&(E=O.src),i+="var $app_style$ = "+utils.makeRequireString(e,makeLoaderString("style",{source:O.src,lang:O.lang,resourcePath:o}),E)}if(p.script.length){var W=p.script[0],B=o;W.src&&(B=W.src),i+="var $app_script$ = "+utils.makeRequireString(e,makeLoaderString("script",{source:W.src}),B)}return i+="\n$app_define$('@app-component/"+l+"', [], function($app_require$, $app_exports$, $app_module$){\n",0<p.script.length&&(i+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",i+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),i+="     $app_module$.exports.template = $app_template$\n",0<p.style.length&&(i+="     $app_module$.exports.style = $app_style$\n"),i+="})\n",a&&"component"===a.type||(i+="\n$app_bootstrap$('@app-component/"+l+"',{ packagerName:'fa-toolkit', packagerVersion: '"+JSON.parse(fs.readFileSync(packageJsonPath).toString()).subversion.packager+"'})"),i}module.exports=loader;