"use strict";var _parse=require("parse5"),_validator=require("./validator"),_parser=require("parse5/lib/parser"),_tokenizer=require("parse5/lib/tokenizer");function calcSubTextNodesNum(e,t){var a=0;if(_validator.default.isSupportSpan(e)){var r=_validator.default.getTagChildren(e);t.forEach(function(e){("#text"===e.nodeName&&e.value.trim()||-1<r.indexOf(e.nodeName))&&++a})}return a}function traverse(i,s,n,l){_validator.default.checkTagName(i,s),(i.attrs||[]).forEach(function(e){var t=e.name,a=t.match(/^:+/);a&&(t=t.slice(a.length));var r=e.value,o={line:1,column:1};switch(i.__location&&(o={line:i.__location.line,column:i.__location.col}),t){case"id":_validator.default.checkId(r,s),_validator.default.checkAttr(t,r,s,i.tagName,o);break;case"class":_validator.default.checkClass(r,s);break;case"style":_validator.default.checkStyle(r,s,o,i.tagName);break;case"if":i._isroot||_validator.default.checkIf(r,s,!1,o,n);break;case"else":i._isroot||l&&l.__cond__&&_validator.default.checkElse(l.__cond__,s,o,n);break;case"elif":i._isroot||l&&l.__cond__&&(i.__cond__=_validator.default.checkElif(r,l.__cond__,s,o,n));break;case"for":i._isroot||_validator.default.checkFor(r,s,o);break;case"tree":_validator.default.checkBuild("tree",s);break;default:t.match(/^(on|@)/)?_validator.default.checkEvent(t,r,s):_validator.default.checkAttr(t,r,s,i.tagName,o)}});var d=s.result,c=i.childNodes;if(c&&c.length){var u=void 0,f=[],_=calcSubTextNodesNum(d.type,c);c.forEach(function(e,t){if(0<t){var a=c[t-1];a.nodeName.match(/^#/)||(u=a).__cond__||u.attrs&&u.attrs.forEach(function(e){"if"!==e.name&&"elif"!==e.name||(u.__cond__=e.value)})}var r={};if(e.nodeName.match(/^#/)){if("#text"===e.nodeName&&e.value.trim()){if(_validator.default.isSupportSpan(i.tagName)&&2<=_&&(r.type="span",s.result=r,d.children=d.children||[],d.children.push(r),_validator.default.checkAttr("value",e.value,s)),"option"===i.tagName){var o=s.result;return(s.result=d).attr.hasOwnProperty("value")||_validator.default.checkAttr("value",e.value,s),_validator.default.checkAttr("content",e.value,s),void(s.result=o)}if("marquee"===i.tagName){var n=s.result;s.result=d,_validator.default.checkAttr("value",e.value,s),s.result=n}if(_validator.default.isSupportSpan(i.tagName)&&1===_||_validator.default.isTextContentAomtic(i.tagName)){var l=s.result;s.result=d,_validator.default.checkAttr("value",e.value,s),s.result=l}}}else s.result=r,d.children=d.children||[],d.children.push(r),traverse(e,s,f,u)}),d.children&&0===d.children.length&&(d.children=void 0)}s.result=d}function checkNode(e,t,a){var r=(t.tagName||"").toLowerCase(),o=t.selfClosing,n=_validator.default.isSupportedSelfClosing(r);if(e.nodeInfo.tn&&r&&!e.nodeInfo.sc){var l=String(t.location.line)+String(t.location.col);n&&(l===e.nodeInfo.pos||t.type!==_tokenizer.START_TAG_TOKEN)||(a.log.push({reason:"ERROR: The "+e.nodeInfo.tn+" tag must be closed. This is required by the XML specifications."}),e.nodeInfo={})}r&&n&&(t.type!==_tokenizer.START_TAG_TOKEN||o||(e.nodeInfo.tn=r,e.nodeInfo.sc=!1,e.nodeInfo.pos=String(t.location.line)+String(t.location.col)),t.type===_tokenizer.END_TAG_TOKEN&&r===e.nodeInfo.tn&&(e.nodeInfo.sc=!0))}function initParser(e,t,n){var a=new _parser(t),l=a._appendElement,i=a._insertElement;return a._insertElement=function(e,t){var a=(e.tagName||"").toLowerCase(),r=e.selfClosing,o=_validator.default.isSupportedSelfClosing(a);r&&!o&&n.log.push({reason:"ERROR: `"+a+"` must not be a self-closing tag. "}),o||r&&a?l.apply(this,arguments):i.apply(this,arguments)},a.nodeInfo={},a._runParsingLoop=function(e){for(;!this.stopped;){this._setupTokenizerCDATAMode();var t=this.tokenizer.getNextToken();if(checkNode(a,t,n),t.type===_tokenizer.HIBERNATION_TOKEN)break;if(this.skipNextNewLine&&(this.skipNextNewLine=!1,t.type===_tokenizer.WHITESPACE_CHARACTER_TOKEN&&"\n"===t.chars[0])){if(1===t.chars.length)continue;t.chars=t.chars.substr(1)}if(this._processInputToken(t),e&&this.pendingScript)break}},a.parseFragment(e)}function parse(e,t){var a=e&&e.versionNum,r=e&&e.widgetsPathList,o={result:{},depends:[],log:[],filePath:e.filePath,versionNum:a,widgetsPathList:r},n=initParser(e.code,{treeAdapter:_parse.treeAdapters.default,locationInfo:!0},o);if(!n||!n.childNodes)return o.log.push({reason:"ERROR: Template parsing failed.",line:1,column:1}),void t(null,{jsonTemplate:o.result,depends:o.depends,log:o.log});var l=n.childNodes.filter(function(e){return"#"!==e.nodeName.charAt(0)});if(1!==l.length)return i=0===l.length?"ERROR: No valid root node is found.":"ERROR: Only one root node is allowed.",o.log.push({reason:i,line:1,column:1}),void t(null,{jsonTemplate:o.result,depends:o.depends,log:o.log});var i,s=l[0];return s._isroot=!0,traverse(s,o,{}),void t(null,{jsonTemplate:o.result,depends:o.depends,log:o.log})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default={parse:parse};