"use strict";var _fs=require("fs"),_path=require("path"),_archiver=require("archiver"),_utils=require("./utils"),_bundle=require("./bundle");function signRpkFile(){_utils.mkdirsSync(options.output);var a=[],t=_path.join(options.output,"bundle."+(new Date).getTime()+".zip"),e=_fs.createWriteStream(t),r=_archiver("zip");e.on("finish",function(){var e=_path.join(options.output,options.name+".rpk"),i=_fs.readFileSync(privateKeyFilePath),r=_fs.readFileSync(certificateFilePath);_bundle.signZip({zip:t,files:a},i,r,e),_fs.existsSync(t)&&_fs.unlinkSync(t)}),r.on("error",function(e){console.error("ERROR: Packaging error. Please try again.")}),r.pipe(e),parse(options.src,".",function(e,i){a.push({name:Buffer.from(e),file:i,hash:_bundle.hashFile(i)}),r.append(_fs.createReadStream(i),{name:e})}),r.finalize()}function parse(n,s,p){s=s||".";var o,c=_path.join(n,s);_fs.readdirSync(c).forEach(function(e){var i=_path.join(c,e),r=_fs.statSync(i);if(r.isFile()){var a=s.split(_path.sep).join(_path.posix.sep);o=_path.posix.join(a,_path.basename(e)),p(o,i)}else if(r.isDirectory()){var t=_path.join(s,e);parse(n,t,p)}})}var options=JSON.parse(process.argv[2]),privateKeyFilePath=process.argv[3],certificateFilePath=process.argv[4];signRpkFile();