"use strict";var rootNode,node,jsonData,_fs=require("fs"),_path=require("path"),xmlParser=require("htmlparser2"),fastXmlParser=require("fast-xml-parser"),_utils=require("./utils"),projectPath=process.env.projectRoot||process.cwd(),rootDir=_path.join(projectPath,"src"),REGEXP_NAME=/(^[\u4e00-\u9fa5\w-（）()]([\u4e00-\u9fa5\w-（）()\s]*[\u4e00-\u9fa5\w-（）()])?$)/,REGEXP_LINK_PARAMETER=/^[A-Za-z0-9_]{1,128}/,validator={version:function(e,t){return 10<(t=(t||"").toString()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:t.match(/^[1-9][0-9]*$/)?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},intent:function(e,t){return 64<(t=(t||"").toString()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},name:function(e,t){return 64<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:t.match(REGEXP_NAME)&&""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},icon:function(e,t){t=(t||"").toString();var n=_path.join(rootDir,t);return 256<t.length?{reason:"The path `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:_fs.existsSync(n)||""===t.trim()?{value:t}:{reason:"The path `"+t+"` of `"+e+"` does not exist."}},description:function(e,t){return 256<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},link:function(e,t){return 1024<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},linkparameter:function(e,t){return 128<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:t.match(REGEXP_LINK_PARAMETER)&&""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},intentparameter:function(e,t){return 128<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}},testvalue:function(e,t){return 128<(t=(t||"").toString().trim()).length?{reason:"The value `"+t+"`of `"+e+"` has exceeded the maximum limit for length."}:""!==t.trim()?{value:t}:{reason:"The value `"+t+"` of `"+e+"` is invalid."}}},xmlNatives={aml:{attrs:{version:{required:!0,checkFunc:validator.version}}},ability:{attrs:{intent:{required:!0,checkFunc:validator.intent}},parents:["aml"]},display:{attrs:{name:{required:!0,checkFunc:validator.name},icon:{checkFunc:validator.icon},description:{required:!0,checkFunc:validator.description}},parents:["ability"]},service:{attrs:{link:{required:!0,checkFunc:validator.link}},parents:["ability"]},parameter:{attrs:{linkparameter:{required:!0,checkFunc:validator.linkparameter},intentparameter:{required:!0,checkFunc:validator.intentparameter},testvalue:{required:!0,checkFunc:validator.testvalue},urlencoding:{enum:["true","false"]}},parents:["service"]}},xmlReserved=[],xmlAttrMap={},xmlRequireAttrMap={},xmlEnumAttrMap={},xmlFuncAttrMap={},xmlParentsMap={};function isReservedXml(e){return-1<xmlReserved.indexOf(e)}function checkAbility(e,t){return htmlparser2xml(e,t),e}Object.keys(xmlNatives).forEach(function(e){xmlReserved.push(e);var n,t=xmlNatives[e],a={},r=[],i=[];n=_utils.extend({},t.attrs),Object.keys(n).forEach(function(e){var t=n[e];t.enum&&0<t.enum.length&&(a[e]=t.enum),!0===t.required&&i.push(e),t.checkFunc&&(r[e]=t.checkFunc)}),xmlAttrMap[e]=n,xmlFuncAttrMap[e]=r,xmlRequireAttrMap[e]=i,xmlEnumAttrMap[e]=a,xmlParentsMap[e]=t.parents?_utils.merge([],t.parents):null});var eType,stack=[],amlCount=0,tagNameArr=[];function htmlparser2xml(e,n){var t=new xmlParser.Parser({onprocessinginstruction:function(e,t){},onattribute:function(e,t){checkAbilityIntentIsRepeat(e,t,n)},onopentag:function(e,t){rootNode||(rootNode=e),(node={}).name=e,stack.push(node),checkAttrs(e,t,n)},ontext:function(e){},onclosetag:function(e){tagNameArr.push(e),"aml"===e&&amlCount++;var t=stack.pop();if(0===stack.length)jsonData=t;else{var n=stack[stack.length-1];n.childs||(n.childs=[]),n.childs.push(t)}},onerror:function(e){},onend:function(){}},{xmlMode:!0,lowerCaseAttributeNames:!0});t.write(e),t.end(),jsonData&&(1<tagNameArr.length&&checkLastTagName(tagNameArr,n),checkAmlCount(amlCount,n),checkParent(jsonData,rootNode,n))}function checkLastTagName(e,t){"aml"!==e[e.length-1]&&(console.warn("WARNING: Only one root node is allowed or root node is not `aml`\n @ "+t+"\n"),eType.type="WARN",eType.warnCount++)}function checkAmlCount(e,t){1!==e&&(console.warn("WARNING: Only one root node is allowed or root node is not `aml` or `aml` does not exist\n @ "+t+"\n"),eType.type="WARN",eType.warnCount++)}var intentValueList=[];function checkAbilityIntentIsRepeat(e,t,n){t=t.toString().trim(),"intent"===e&&(intentValueList.length<1?intentValueList.push(t):-1<intentValueList.indexOf(t)?(console.warn("WARNING: The`"+t+"`of`"+e+"`is not allowed to be repeated\n @ "+n+"\n"),eType.type="WARN",eType.warnCount++):intentValueList.push(t))}function checkParent(e,t,n){"aml"!==t&&(console.warn("WARNING: Root node label `"+t+"` of the XML file is invalid.\n @ "+n+"\n"),eType.type="WARN",eType.warnCount++),traverse(e,n)}function traverse(e,n){var a=e.name||"";e.childs&&0<e.childs.length&&e.childs.forEach(function(e){var t=e.name||"";checkTagParent(a,t,n),"ability"===t&&checkServiceCount(e,n),traverse(e,n)})}function checkTagParent(e,t,n){xmlParentsMap[t]?xmlParentsMap[t][0]!==e&&(console.warn("WARNING: `"+t+"` cannot be used as the sub-tag of `"+e+"`\n @ "+n+"\n"),eType.type="WARN",eType.warnCount++):(console.warn("WARNING: `"+t+"` cannot be used as the sub-tag of `"+e+"`\n @ "+n+"\n"),eType.type="WARN",eType.warnCount++)}function checkServiceCount(e,t){var n=0;e&&e.childs&&e.childs.forEach(function(e){e.name&&"service"===e.name&&n++}),1<n&&(console.warn("WARNING: Sub-tag `service` of `ability` supports only one `\n @ "+t+"\n"),eType.type="WARN",eType.warnCount++)}function checkAttrs(i,o,l){isReservedXml(i)||(console.warn("WARNING: The ability.xml file contains invalid tag `"+i+"`\n @ "+l+"\n"),eType.type="WARN",eType.warnCount++);var s=[];Object.keys(o).forEach(function(e){s.push(e)}),xmlAttrMap[i]&&s.forEach(function(e){e in xmlAttrMap[i]||(console.warn("WARNING: Tag `"+i+"` contains invalid attribute `"+e+"`\n @ "+l+"\n"),eType.type="WARN",eType.warnCount++)}),xmlRequireAttrMap[i]&&xmlRequireAttrMap[i].forEach(function(e){s.indexOf(e)<0&&(console.warn("WARNING: Tag `"+i+"` does not define attribute `"+e+"`\n @ "+l+"\n"),eType.type="WARN",eType.warnCount++)}),xmlEnumAttrMap[i]&&Object.keys(xmlEnumAttrMap[i]).forEach(function(e){if(0<=s.indexOf(e)){var t=o[e].trim();xmlEnumAttrMap[i][e].indexOf(t)<0&&(console.warn("WARNING: Tag`"+t+"`attribute `"+e+"` value `"+t+"`is invalid.\n @ "+l+"\n"),eType.type="WARN",eType.warnCount++)}}),xmlFuncAttrMap[i]&&Object.keys(xmlFuncAttrMap[i]).forEach(function(e){if(0<=s.indexOf(e)){var t=o[e],n=xmlFuncAttrMap[i][e];if("function"==typeof n){var a=n(e,t);if(a&&a.reason){var r=a.reason;console.warn("WARNING: Tag `"+i+"`attribute "+r+"\n @ "+l+"\n"),eType.type="WARN",eType.warnCount++}}}})}function abilityCopyAndCheck(e){if(eType={type:null,warnCount:0},_fs.existsSync(e)){try{var t=_fs.readFileSync(e,"utf8"),n=_path.join(e,"..","..","build","ability.xml"),a=fastXmlParser.validate(t);a.err&&(console.warn("WARNING: An error occurred when parsing the file["+n+"]："+a.err.msg+"\n"),eType.type="WARN",eType.warnCount++),_fs.writeFileSync(n,checkAbility(t,e),"utf8")}catch(e){console.warn("WARNING: An error occurred when reading ["+n+"]: "+e.message),eType.type="WARN",eType.warnCount++}return eType}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.abilityCopyAndCheck=abilityCopyAndCheck;