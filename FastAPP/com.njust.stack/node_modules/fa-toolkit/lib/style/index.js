"use strict";var _utils=require("../utils"),_validator=require("./validator"),_css=require("css"),_fs=require("fs"),_path=require("path"),_cssWhat=require("css-what"),projectPath=process.env.projectRoot||process.cwd(),srcPath=_path.join(projectPath,"src"),buildPath=_path.join(projectPath,"build"),SELECTOR_MATCHER=/^[\.#]?[A-Za-z0-9_\-:]+$/,DESCENDANT_SELECTOR_MATCHER=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/,URL_MATCH_G=/url\(\s*['"]?\s*([^()]+?)\s*['"]?\s*\)/g,URL_VALUE=/^url\(\s*['"]?\s*([^()]+?)\s*['"]?\s*\)$/,REGEXP_LOCAL=/^local\(\s*(['"]?)\s*([^'"()]+?)\s*\1\s*\)$/,COMPRESS_CSS_LIST=[{newN:"t",oldN:"type",newV:["d","a","t","u","p","pe"],oldV:["descendant","attribute","tag","universal","pseudo","pseudo-element"]},{newN:"n",oldN:"name"},{newN:"i",oldN:"ignoreCase"},{newN:"a",oldN:"action"},{newN:"v",oldN:"value"}];function processImport(e,c,f){var v=e,t=e.match(/(@import\s+['"]([^()]+?)['"]\s*;)|(@import\s+['"]([^()]+?)['"]\s+(only|not)?\s?(screen)?\s?((and|or|,|not|landscape)?\s?[(]([^()])+[)]\s*)+)/g),d=c;return t&&0<t.length&&(c?t.forEach(function(e){var t=e.slice(8),a=parseInt(t.lastIndexOf("'"))+2;1==a&&(a=parseInt(t.lastIndexOf('"'))+2);var r=t.slice(a).trim();if(r.length){(r=(r=r.replace(new RegExp(",",""),"or")).replace(/[(]([^()])+[)]/g,function(e){return e.replace(/\s+/g,"")})).endsWith(";")&&(r=r.substring(0,r.lastIndexOf(";")));var o="";if(-1!=r.indexOf("(")&&(o="@media "+r,o+="{\n"),1<(l=e.match(/['"]([^()]+?)['"]/)).length){i=_path.resolve(c,l[1]);o+=s=_fs.readFileSync(i),-1!=r.indexOf("(")&&(o+="\n}"),v+=o}else f.push({line:1,column:1,reason:"ERROR: Failed to find file `"+e+"`. Import failed."})}else{var l;if(1<(l=e.match(/['"]([^()]+?)['"]/)).length){var s,i=_path.resolve(c,l[1]);if(s=_fs.readFileSync(i)){var n=_path.dirname(i);d=n;var u=processImport(s.toString(),n,f),p=u.match(URL_MATCH_G);p&&0<p.length&&p.forEach(function(e){var t=e.match(URL_VALUE);if(t&&t.length&&t[1].match(/^\s*\.\.\/|^\s*\.\//)){var a=relativePath2fullPath(t[1].trim(),d);u=u.replace(e,"url('"+a+"')")}}),v=v.replace(e,"\n"+u+"\n")}}else f.push({line:1,column:1,reason:"ERROR: Failed to find file `"+e+"`. Import failed."})}}):f.push({line:1,column:1,reason:"ERROR: Failed to find the resource path. @import cannot be processed."})),v}function parse(e,t){var a=void 0,o={},d=[],h="",r=e&&e.code||"",l=e&&e.query,s=e&&e.versionNum,m=e&&e.widgetsPathList;l&&(r=processImport(r=r.replace(/\/\*\*?[\s\S]*?\*\//g,""),_path.dirname(l.resourcePath),d),h=_path.dirname(l.resourcePath));var i=_css.parse(r,{silent:!0});i.stylesheet.parsingErrors&&i.stylesheet.parsingErrors.length&&(a=i.stylesheet.parsingErrors).forEach(function(e){d.push({line:e.line,column:e.column,reason:e.toString()})}),i&&"stylesheet"===i.type&&i.stylesheet&&i.stylesheet.rules&&i.stylesheet.rules.length&&i.stylesheet.rules.forEach(function(c){var e=c.type,f={};if("rule"===e)c.declarations&&c.declarations.length&&(c.declarations.forEach(function(e){var t=e.type,a=void 0,r=void 0,o=void 0,l=void 0;if("declaration"===t){if(a=e.property,r=e.value,"objectFitImage"===(l=_utils.hyphenedToCamelCase(a))&&d.push({line:c.position.start.line,column:c.position.start.column,reason:"ERROR: Style `"+_utils.camelCaseToHyphened(l)+"` is not supported."}),"number"==typeof(o=_validator.validate(l,r)).value||"string"==typeof o.value)if("padding"==l||"margin"==l){var s=[l+"Top",l+"Right",l+"Bottom",l+"Left"];_utils.splitAttr(f,o.value,s)}else if("border"==l){o.value.split(/\s+/).forEach(function(e){var t=JSON.parse(e);if("Width"===t.type||"Color"===t.type){var a=[l+"Top"+t.type,l+"Right"+t.type,l+"Bottom"+t.type,l+"Left"+t.type];_utils.splitAttr(f,t.value,a)}else f[l+t.type]=t.value})}else if("borderLeft"===l||"borderRight"===l||"borderTop"===l||"borderBottom"===l){o.value.split(/\s+/).forEach(function(e){var t=JSON.parse(e);if("Width"===t.type||"Color"===t.type||"Style"===t.type){var a=[l+t.type];_utils.splitAttr(f,t.value,a)}})}else if("borderWidth"==l){_utils.splitAttr(f,o.value,["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"])}else if("borderColor"==l){_utils.splitAttr(f,o.value,["borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"])}else if("mylocation"==l){var i=o.value.split(/\s+/),n=[];i.forEach(function(e){var t=JSON.parse(e);"Color"===t.type?n.push(t.value):f[l+"IconPath"]=t.value}),f[l+"FillColor"]=n[0],f[l+"StrokeColor"]=n[1]}else{if(r.match(URL_MATCH_G)&&-1<m.indexOf(h)){var u=o.value;o.value=trans2Base64(u,h)}f[l]=o.value}if(o.value&&o.value.isRelative){var p="";if(-1<m.indexOf(h))p=trans2Base64(o.value.value,h);else p=relativePath2fullPath(o.value.value,h);f[l]=p}o.log&&d.push({line:e.position.start.line,column:e.position.start.column,reason:o.log.reason})}}),c.selectors.forEach(function(e){var t={key:e,val:f};if(e.match(SELECTOR_MATCHER)){if(!processPseudoClass(t,d,c))return;o[t.key]?(e!==t.key||_utils.equals(o[t.key],t.val,cssCompare)||d.push({line:c.position.start.line,column:c.position.start.column,reason:"WARNING: Selector `"+t.key+"` already exists. The latter will be merged into the former."}),o[t.key]=_utils.extend({},o[t.key],t.val)):o[t.key]=t.val}else if(e.match(DESCENDANT_SELECTOR_MATCHER)){if(!processPseudoClass(t,d,c))return;if(o[t.key]){e!==t.key||_utils.equals(o[t.key],t.val,cssCompare)||d.push({line:c.position.start.line,column:c.position.start.column,reason:"WARNING: Selector `"+t.key+"` already exists. The latter will be merged into the former."});try{t.val=Object.assign({},t.val),s<1040&&(t.val._meta={},t.val._meta.ruleDef=compressCss(_cssWhat(t.key))),o[t.key]=_utils.extend({},o[t.key],t.val)}catch(e){return void d.push({line:c.position.start.line,column:c.position.start.column,reason:"ERROR: Selector `"+t.key+"` is not supported."})}}else try{t.val=Object.assign({},t.val),s<1040&&(t.val._meta={},t.val._meta.ruleDef=compressCss(_cssWhat(t.key))),o[t.key]=t.val}catch(e){return void d.push({line:c.position.start.line,column:c.position.start.column,reason:"ERROR: Selector `"+t.key+"` is not supported."})}}else d.push({line:c.position.start.line,column:c.position.start.column,reason:"ERROR: Selector `"+e+"` is invalid."})}));else if("font-face"===e){if(c.declarations&&c.declarations.length){var v={};c.declarations.forEach(function(e){if("declaration"===e.type){var t=(0,_utils.hyphenedToCamelCase)(e.property),a=e.value;if("fontFamily"===t)v.fontFamily=e.value.replace(/['"]+/g,"");else if("src"===t){var r=_validator.validate(t,a);if(r.value.length){for(var o=[],l=0,s=r.value.length;l<s;l++){var i=r.value[l];if(i.match(/^\.\.\/|^\.\//)){var n=relativePath2fullPath(i,h);o.push(n)}else if(i.match(/^\s*local\s*\(/)){var u=REGEXP_LOCAL.exec(i),p=u&&u[2].trim();o.push(p)}else o.push(i)}a=o}v.src=a}else d.push({line:c.position.start.line,column:c.position.start.column,reason:"WARNING: @font-face does not support `"+t+"`."})}}),o["@FONT-FACE"]||(o["@FONT-FACE"]={}),o["@FONT-FACE"][v.fontFamily]=v}}else if("keyframes"===e&&c.keyframes&&c.keyframes.length){var a=c.name,r=[];c.keyframes.forEach(function(e){var l=void 0;if("keyframe"===e.type&&e.declarations&&e.declarations.length)if(l={},e.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,r=_utils.hyphenedToCamelCase(t),o=_validator.validate(r,a);"number"!=typeof o.value&&"string"!=typeof o.value||(l[r]=o.value),o.log&&d.push({line:e.position.start.line,column:e.position.start.column,reason:o.log.reason})}}),_utils.isEmptyObject(l))d.push({line:c.position.start.line,column:c.position.start.column,reason:"ERROR: Animation `"+a+"` key frame `"+JSON.stringify(e.values)+"` does not have a valid attribute."});else{var t=void 0;e.values.forEach(function(e){t="from"===e?0:"to"===e?100:parseFloat(e.replace("%","")),l.time=t,r.push(l)})}}),r.sort(function(e,t){return e.time-t.time}),o["@KEYFRAMES"]||(o["@KEYFRAMES"]={}),o["@KEYFRAMES"][a]=r}else if("media"===e&&c.rules&&c.rules.length){var p={},t=(c=JSON.parse(JSON.stringify(c))).media;p.condition=t,c.rules.forEach(function(e){if(e&&e.selectors&&!(e.selectors.length<=0)){var n=e.selectors[0];p[n]={};var u={};e.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,r=_utils.hyphenedToCamelCase(t),o=_validator.validate(r,a);if("number"==typeof o.value||"string"==typeof o.value){if("padding"==r||"margin"==r){var l=[r+"Top",r+"Right",r+"Bottom",r+"Left"];_utils.splitAttr(u,o.value,l)}else if("border"==r){o.value.split(/\s+/).forEach(function(e){var t=JSON.parse(e);if("Width"===t.type||"Color"===t.type){var a=[r+"Top"+t.type,r+"Right"+t.type,r+"Bottom"+t.type,r+"Left"+t.type];_utils.splitAttr(u,t.value,a)}else u[r+t.type]=t.value})}else if("borderLeft"===r||"borderRight"===r||"borderTop"===r||"borderBottom"===r){o.value.split(/\s+/).forEach(function(e){var t=JSON.parse(e);if("Width"===t.type||"Color"===t.type||"Style"===t.type){var a=[r+t.type];_utils.splitAttr(u,t.value,a)}})}else if("borderWidth"==r){_utils.splitAttr(u,o.value,["borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth"])}else if("borderColor"==r){_utils.splitAttr(u,o.value,["borderTopColor","borderRightColor","borderBottomColor","borderLeftColor"])}else if("mylocation"==r){var s=o.value.split(/\s+/),i=[];s.forEach(function(e){var t=JSON.parse(e);"Color"===t.type?i.push(t.value):u[r+"IconPath"]=t.value}),u[r+"FillColor"]=i[0],u[r+"StrokeColor"]=i[1]}else u[r]=o.value;p[n]=u}o.log&&d.push({line:e.position.start.line,column:e.position.start.column,reason:o.log.reason})}})}}),o["@MEDIA"]||(o["@MEDIA"]=[]),o["@MEDIA"].push(p)}}),t(a,{jsonStyle:o,log:d})}function cssCompare(e,t,a){if("_meta"===a)return!0}function relativePath2fullPath(e,t){var a=_path.join(t,e).toString().replace(srcPath,"");return a=a.replace(/\\/g,"/")}function trans2Base64(e,t){var a,r="";if(e.match(/^\.\.\/|^\.\//))r=relativePath2fullPath(e,t);else{if(!e.match(/^\//))return e;r=e}a=_path.join(buildPath,r);var o=_path.extname(a).replace(".",""),l=_fs.readFileSync(a);return e="data:image/"+o+";base64,"+Buffer.from(l,"binary").toString("base64")}function compressCss(a){a=a[0]||[];for(var r=0;r<a.length;r++)!function(e){var t=a[r]||{};COMPRESS_CSS_LIST.forEach(function(e){t.hasOwnProperty(e.oldN)&&(t[e.newN]=t[e.oldN],delete t[e.oldN],e.oldV&&-1<e.oldV.indexOf(t[e.newN])&&(t[e.newN]=e.newV[e.oldV.indexOf(t[e.newN])]))})}();return a}function processPseudoClass(t,e,a){var r=t.key.indexOf(":");if(-1<r){var o=t.key.slice(r);if(!_validator.validatePseudoClass(o))return e.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: PseudoClass selector `"+o+"` is not supported."}),!1;t.key=t.key.slice(0,r);var l={};Object.keys(t.val).forEach(function(e){l[e+o]=t.val[e]}),t.val=l}return!0}function validate(t,e){var o=[],a=void 0;try{t=JSON.parse(JSON.stringify(t))}catch(e){a=e,t={}}Object.keys(t).forEach(function(e){var r=t[e];Object.keys(r).forEach(function(e){var t=r[e],a=_validator.validate(e,t);"number"==typeof a.value||"string"==typeof a.value?r[e]=a.value:delete r[e],a.log&&o.push(a.log)})}),e(a,{jsonStyle:t,log:o})}module.exports={parse:parse,validate:validate,validateDelaration:_validator.validate,validator:_validator.validator,relativePath2fullPath:relativePath2fullPath,trans2Base64:trans2Base64};